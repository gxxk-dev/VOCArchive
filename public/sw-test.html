<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Worker æµ‹è¯• - VOCArchive</title>
    <style>
        body {
            font-family: sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }

        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }

        .test-section h2 {
            margin-top: 0;
            color: #495057;
        }

        .status {
            padding: 10px 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #0056b3;
        }

        .log {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .test-url {
            background: #e9ecef;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: monospace;
            margin: 10px 0;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ› ï¸ Service Worker è·¨åŸŸç¼“å­˜æµ‹è¯•</h1>

        <!-- å…¨å±€æ“ä½œ -->
        <div style="text-align: center; padding: 20px 0; border-bottom: 1px solid #ddd; margin-bottom: 20px;">
            <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <button onclick="runAllTests()" style="background: #28a745;">
                    ğŸ”„ è¿è¡Œæ‰€æœ‰æµ‹è¯•
                </button>
                <button onclick="resetAllTests()" style="background: #6c757d;">
                    ğŸ—‘ï¸ é‡ç½®çŠ¶æ€
                </button>
                <button onclick="exportLog()" style="background: #17a2b8;">
                    ğŸ“„ å¯¼å‡ºæ—¥å¿—
                </button>
            </div>
        </div>

        <!-- Service Worker çŠ¶æ€ -->
        <div class="test-section">
            <h2>1. Service Worker çŠ¶æ€æ£€æŸ¥</h2>
            <div id="sw-status" class="status info">æ£€æŸ¥ä¸­...</div>
            <button onclick="checkServiceWorker()">é‡æ–°æ£€æŸ¥</button>
            <button onclick="forceUpdateServiceWorker()">å¼ºåˆ¶æ›´æ–°SW</button>
        </div>

        <!-- é…ç½®ç«¯ç‚¹æµ‹è¯• -->
        <div class="test-section">
            <h2>2. é…ç½®ç«¯ç‚¹æµ‹è¯•</h2>
            <div id="config-status" class="status info">æœªæµ‹è¯•</div>
            <button onclick="testConfigEndpoint()">æµ‹è¯•é…ç½®ç«¯ç‚¹</button>
            <button onclick="checkServiceWorkerConfig()">æ£€æŸ¥SWé…ç½®</button>
            <div class="test-url">/api/sw_config.js</div>
        </div>

        <!-- å¤–éƒ¨å­˜å‚¨æµ‹è¯• -->
        <div class="test-section">
            <h2>3. å¤–éƒ¨å­˜å‚¨ä¸»æœºæ£€æµ‹</h2>
            <div id="external-hosts" class="status info">æœªæ£€æµ‹</div>
            <div id="hosts-list"></div>
            <button onclick="checkExternalHosts()">æ£€æµ‹å¤–éƒ¨ä¸»æœº</button>
        </div>

        <!-- æ–‡ä»¶é‡å®šå‘æµ‹è¯• -->
        <div class="test-section">
            <h2>4. æ–‡ä»¶é‡å®šå‘æµ‹è¯•</h2>
            <div id="redirect-status" class="status info">æœªæµ‹è¯•</div>
            <button onclick="testFileRedirect()">æµ‹è¯•æ–‡ä»¶é‡å®šå‘</button>
            <div class="test-url">/api/get/file/{uuid}</div>
        </div>

        <!-- ç¼“å­˜æµ‹è¯• -->
        <div class="test-section">
            <h2>5. ç¼“å­˜åŠŸèƒ½æµ‹è¯•</h2>
            <div id="cache-status" class="status info">æœªæµ‹è¯•</div>
            <button onclick="testCaching()">æµ‹è¯•ç¼“å­˜åŠŸèƒ½</button>
            <button onclick="clearTestCache()">æ¸…ç†æµ‹è¯•ç¼“å­˜</button>
            <button onclick="testExternalFileCache()">æµ‹è¯•å¤–éƒ¨æ–‡ä»¶ç¼“å­˜</button>
        </div>

        <!-- å®æ—¶æ—¥å¿— -->
        <div class="test-section">
            <h2>6. å®æ—¶æ—¥å¿—</h2>
            <div style="margin-bottom: 10px;">
                <button onclick="clearLog()" style="background: #6c757d; font-size: 14px; padding: 8px 16px;">
                    ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—
                </button>
                <button onclick="exportLog()" style="background: #17a2b8; font-size: 14px; padding: 8px 16px;">
                    ğŸ“„ å¯¼å‡ºæ—¥å¿—
                </button>
            </div>
            <div id="log" class="log">ç­‰å¾…æ—¥å¿—è¾“å‡º...
</div>
        </div>
    </div>

    <script>
        let testResults = {};

        // æ—¥å¿—åŠŸèƒ½
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEl = document.getElementById('log');
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
            logEl.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').textContent = 'ç­‰å¾…æ—¥å¿—è¾“å‡º...\n';
        }

        // é‡ç½®æ‰€æœ‰æµ‹è¯•çŠ¶æ€
        function resetAllTests() {
            testResults = {};

            // é‡ç½®æ‰€æœ‰çŠ¶æ€æ˜¾ç¤º
            updateStatus('sw-status', 'æ£€æŸ¥ä¸­...', 'info');
            updateStatus('config-status', 'æœªæµ‹è¯•', 'info');
            updateStatus('external-hosts', 'æœªæ£€æµ‹', 'info');
            updateStatus('redirect-status', 'æœªæµ‹è¯•', 'info');
            updateStatus('cache-status', 'æœªæµ‹è¯•', 'info');

            // æ¸…ç©ºä¸»æœºåˆ—è¡¨
            const hostsList = document.getElementById('hosts-list');
            if (hostsList) {
                hostsList.innerHTML = '';
            }

            // æ¸…ç©ºæ—¥å¿—
            clearLog();
            log('æ‰€æœ‰æµ‹è¯•çŠ¶æ€å·²é‡ç½®', 'success');
        }

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            log('å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...', 'info');

            await checkServiceWorker();

            if (testResults.serviceWorker) {
                await testConfigEndpoint();
                await checkExternalHosts();
                await testFileRedirect();
                await testCaching();
            }

            log('æ‰€æœ‰æµ‹è¯•å®Œæˆ', 'success');
        }

        // å¯¼å‡ºæ—¥å¿—
        function exportLog() {
            const logContent = document.getElementById('log').textContent;
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `sw-test-log-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            log('æ—¥å¿—å·²å¯¼å‡º', 'success');
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.className = `status ${type}`;
        }

        // 1. æ£€æŸ¥ Service Worker çŠ¶æ€
        async function checkServiceWorker() {
            log('æ£€æŸ¥ Service Worker çŠ¶æ€...');

            if (!('serviceWorker' in navigator)) {
                updateStatus('sw-status', 'âŒ æµè§ˆå™¨ä¸æ”¯æŒ Service Worker', 'error');
                log('æµè§ˆå™¨ä¸æ”¯æŒ Service Worker', 'error');
                return false;
            }

            try {
                const registration = await navigator.serviceWorker.getRegistration();

                if (registration && registration.active) {
                    updateStatus('sw-status', 'âœ… Service Worker å·²æ¿€æ´»', 'success');
                    log('Service Worker å·²æ¿€æ´»: ' + registration.scope, 'success');

                    // ç›‘å¬æ¶ˆæ¯
                    navigator.serviceWorker.addEventListener('message', handleServiceWorkerMessage);

                    testResults.serviceWorker = true;
                    return true;
                } else {
                    updateStatus('sw-status', 'âš ï¸ Service Worker æœªæ¿€æ´»', 'error');
                    log('Service Worker æœªæ¿€æ´»ï¼Œè¯·åˆ·æ–°é¡µé¢', 'error');
                    testResults.serviceWorker = false;
                    return false;
                }
            } catch (error) {
                updateStatus('sw-status', 'âŒ Service Worker æ£€æŸ¥å¤±è´¥', 'error');
                log('Service Worker æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');
                testResults.serviceWorker = false;
                return false;
            }
        }

        // å¼ºåˆ¶æ›´æ–°Service Worker
        async function forceUpdateServiceWorker() {
            log('å¼ºåˆ¶æ›´æ–°Service Worker...');

            try {
                const registration = await navigator.serviceWorker.getRegistration();
                if (registration) {
                    log('æ‰¾åˆ°Service Workeræ³¨å†Œï¼Œå¼€å§‹æ›´æ–°...', 'info');

                    // å¼ºåˆ¶æ›´æ–°
                    await registration.update();
                    log('Service Workeræ›´æ–°è¯·æ±‚å·²å‘é€', 'info');

                    // ç­‰å¾…æ–°ç‰ˆæœ¬å®‰è£…
                    if (registration.installing) {
                        log('æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬æ­£åœ¨å®‰è£…...', 'info');
                        registration.installing.addEventListener('statechange', (e) => {
                            if (e.target.state === 'installed') {
                                log('æ–°ç‰ˆæœ¬å·²å®‰è£…ï¼Œå‡†å¤‡æ¿€æ´»...', 'info');
                            }
                        });
                    }

                    // å¼ºåˆ¶è·³è¿‡ç­‰å¾…å¹¶æ¿€æ´»æ–°ç‰ˆæœ¬
                    if (registration.waiting) {
                        log('æ¿€æ´»ç­‰å¾…ä¸­çš„æ–°ç‰ˆæœ¬...', 'info');
                        registration.waiting.postMessage({type: 'SKIP_WAITING'});
                    }

                    // é‡æ–°åŠ è½½é¡µé¢ä»¥ä½¿ç”¨æ–°ç‰ˆæœ¬
                    log('3ç§’åå°†é‡æ–°åŠ è½½é¡µé¢ä»¥ä½¿ç”¨æ–°ç‰ˆæœ¬...', 'info');
                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);

                } else {
                    log('æœªæ‰¾åˆ°Service Workeræ³¨å†Œ', 'error');
                }
            } catch (error) {
                log(`å¼ºåˆ¶æ›´æ–°å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // 2. æµ‹è¯•é…ç½®ç«¯ç‚¹
        async function testConfigEndpoint() {
            log('æµ‹è¯•é…ç½®ç«¯ç‚¹...');

            try {
                const response = await fetch('/api/sw_config.js');

                if (response.ok) {
                    const configText = await response.text();

                    // æ£€æŸ¥é…ç½®å†…å®¹
                    if (configText.includes('EXTERNAL_HOSTS') && configText.includes('CACHE_CONFIG')) {
                        updateStatus('config-status', 'âœ… é…ç½®ç«¯ç‚¹æ­£å¸¸', 'success');
                        log('é…ç½®ç«¯ç‚¹è¿”å›æ­£å¸¸ï¼ŒåŒ…å«å¿…è¦çš„é…ç½®é¡¹', 'success');

                        // å°è¯•è§£æå¤–éƒ¨ä¸»æœº
                        const hostsMatch = configText.match(/const EXTERNAL_HOSTS = (\[.*?\]);/);
                        if (hostsMatch) {
                            try {
                                const hosts = JSON.parse(hostsMatch[1]);
                                log(`æ£€æµ‹åˆ°å¤–éƒ¨ä¸»æœº: ${hosts.join(', ')}`, 'info');
                                testResults.externalHosts = hosts;
                            } catch (e) {
                                log('è§£æå¤–éƒ¨ä¸»æœºåˆ—è¡¨å¤±è´¥: ' + e.message, 'error');
                                log('é…ç½®å†…å®¹ç‰‡æ®µ: ' + hostsMatch[1], 'info');

                                // å°è¯•æ›´å®½æ¾çš„è§£æ
                                try {
                                    const hostsStr = hostsMatch[1];
                                    if (hostsStr.includes('assets.vocarchive.com')) {
                                        testResults.externalHosts = ['assets.vocarchive.com'];
                                        log('ä½¿ç”¨å›é€€è§£ææ–¹æ³•æˆåŠŸ', 'success');
                                    }
                                } catch (e2) {
                                    log('å›é€€è§£æä¹Ÿå¤±è´¥: ' + e2.message, 'error');
                                }
                            }
                        } else {
                            log('æœªæ‰¾åˆ° EXTERNAL_HOSTS å£°æ˜', 'error');
                            log('é…ç½®å†…å®¹é¢„è§ˆ: ' + configText.substring(0, 500), 'info');

                            // å°è¯•å…¶ä»–å¯èƒ½çš„æ ¼å¼
                            const alternativeMatch = configText.match(/EXTERNAL_HOSTS\s*=\s*(\[.*?\])/);
                            if (alternativeMatch) {
                                try {
                                    const hosts = JSON.parse(alternativeMatch[1]);
                                    log(`é€šè¿‡æ›¿ä»£æ–¹æ³•æ£€æµ‹åˆ°å¤–éƒ¨ä¸»æœº: ${hosts.join(', ')}`, 'info');
                                    testResults.externalHosts = hosts;
                                } catch (e) {
                                    log('æ›¿ä»£è§£ææ–¹æ³•å¤±è´¥: ' + e.message, 'error');
                                }
                            } else {
                                // å¦‚æœå®Œå…¨æ— æ³•è§£æï¼Œè‡³å°‘è®¾ç½®é»˜è®¤å€¼
                                testResults.externalHosts = ['assets.vocarchive.com'];
                                log('è®¾ç½®é»˜è®¤å¤–éƒ¨ä¸»æœº: assets.vocarchive.com', 'info');
                            }
                        }

                        testResults.configEndpoint = true;
                    } else {
                        updateStatus('config-status', 'âš ï¸ é…ç½®å†…å®¹ä¸å®Œæ•´', 'error');
                        log('é…ç½®ç«¯ç‚¹è¿”å›çš„å†…å®¹ä¸å®Œæ•´', 'error');
                        testResults.configEndpoint = false;
                    }
                } else {
                    updateStatus('config-status', 'âŒ é…ç½®ç«¯ç‚¹è®¿é—®å¤±è´¥', 'error');
                    log(`é…ç½®ç«¯ç‚¹è®¿é—®å¤±è´¥: ${response.status}`, 'error');
                    testResults.configEndpoint = false;
                }
            } catch (error) {
                updateStatus('config-status', 'âŒ é…ç½®ç«¯ç‚¹è¯·æ±‚å¤±è´¥', 'error');
                log('é…ç½®ç«¯ç‚¹è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
                testResults.configEndpoint = false;
            }
        }

        // æ£€æŸ¥Service Workerä¸­çš„é…ç½®çŠ¶æ€
        async function checkServiceWorkerConfig() {
            log('æ£€æŸ¥Service Workerä¸­çš„é…ç½®çŠ¶æ€...');

            if (!navigator.serviceWorker.controller) {
                log('Service Worker æœªæ§åˆ¶å½“å‰é¡µé¢', 'error');
                return;
            }

            try {
                // å‘é€æ¶ˆæ¯ç»™Service Workerè¯·æ±‚é…ç½®çŠ¶æ€
                navigator.serviceWorker.controller.postMessage({
                    type: 'get_sw_config'
                });

                // ç›‘å¬å“åº”
                const configResponseHandler = (event) => {
                    if (event.data && event.data.type === 'sw_config_response') {
                        const config = event.data.config;
                        log('Service Workeré…ç½®çŠ¶æ€:', 'info');
                        log(`- SWç‰ˆæœ¬: ${config.version || 'æœªçŸ¥'}`, 'info');
                        log(`- å¤–éƒ¨ä¸»æœºæ•°é‡: ${config.externalHostsCount}`, 'info');
                        log(`- å¤–éƒ¨ä¸»æœºåˆ—è¡¨: ${config.externalHosts ? config.externalHosts.join(', ') : 'æ— '}`, 'info');
                        log(`- ç¼“å­˜é…ç½®: ${config.hasCacheConfig ? 'å·²åŠ è½½' : 'æœªåŠ è½½'}`, 'info');
                        log(`- èµ„æºæ‰©å±•å: ${config.assetExtensionsCount} ä¸ª`, 'info');

                        navigator.serviceWorker.removeEventListener('message', configResponseHandler);
                    }
                };

                navigator.serviceWorker.addEventListener('message', configResponseHandler);

                // 5ç§’åè¶…æ—¶
                setTimeout(() => {
                    navigator.serviceWorker.removeEventListener('message', configResponseHandler);
                    log('Service Workeré…ç½®æ£€æŸ¥è¶…æ—¶', 'error');
                }, 5000);

            } catch (error) {
                log(`æ£€æŸ¥Service Workeré…ç½®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // 3. æ£€æŸ¥å¤–éƒ¨ä¸»æœº
        async function checkExternalHosts() {
            log('æ£€æŸ¥å¤–éƒ¨å­˜å‚¨ä¸»æœºé…ç½®...');

            if (!testResults.externalHosts) {
                await testConfigEndpoint();
            }

            if (testResults.externalHosts && testResults.externalHosts.length > 0) {
                updateStatus('external-hosts', `âœ… æ£€æµ‹åˆ° ${testResults.externalHosts.length} ä¸ªå¤–éƒ¨ä¸»æœº`, 'success');

                const hostsList = document.getElementById('hosts-list');
                let hostsHtml = '<h4>å¤–éƒ¨å­˜å‚¨ä¸»æœºåˆ—è¡¨:</h4>';

                testResults.externalHosts.forEach(host => {
                    hostsHtml += `<div class="test-url">ğŸŒ ${host}</div>`;

                    // æµ‹è¯•ä¸»æœºè¿é€šæ€§
                    testHostConnectivity(host);
                });

                hostsList.innerHTML = hostsHtml;

                log(`å¤–éƒ¨ä¸»æœºåˆ—è¡¨: ${testResults.externalHosts.join(', ')}`, 'success');
            } else {
                updateStatus('external-hosts', 'âš ï¸ æœªæ£€æµ‹åˆ°å¤–éƒ¨ä¸»æœºæˆ–ä½¿ç”¨é»˜è®¤é…ç½®', 'info');
                log('æœªæ£€æµ‹åˆ°è‡ªå®šä¹‰å¤–éƒ¨å­˜å‚¨ä¸»æœºé…ç½®ï¼Œä½¿ç”¨é»˜è®¤é…ç½®', 'info');
            }
        }

        // æµ‹è¯•ä¸»æœºè¿é€šæ€§
        async function testHostConnectivity(host) {
            try {
                // åˆ›å»ºå¸¦è¶…æ—¶çš„è¯·æ±‚
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5ç§’è¶…æ—¶

                const response = await fetch(`https://${host}`, {
                    method: 'HEAD',
                    mode: 'no-cors',
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                log(`ä¸»æœº ${host} è¿é€šæ€§æµ‹è¯•: å¯è®¿é—®`, 'success');
            } catch (error) {
                if (error.name === 'AbortError') {
                    log(`ä¸»æœº ${host} è¿é€šæ€§æµ‹è¯•: è¶…æ—¶`, 'info');
                } else {
                    log(`ä¸»æœº ${host} è¿é€šæ€§æµ‹è¯•: ${error.message}`, 'info');
                }
            }
        }

        // 4. æµ‹è¯•æ–‡ä»¶é‡å®šå‘
        async function testFileRedirect() {
            log('æµ‹è¯•æ–‡ä»¶é‡å®šå‘åŠŸèƒ½...');

            try {
                // å…ˆè·å–ä¸€ä¸ªæœ‰æ•ˆçš„æ–‡ä»¶UUID
                log('æ­£åœ¨è·å–ä½œå“åˆ—è¡¨...');
                const listResponse = await fetch('/api/list/work/1/1');
                if (!listResponse.ok) {
                    throw new Error(`æ— æ³•è·å–ä½œå“åˆ—è¡¨: ${listResponse.status} ${listResponse.statusText}`);
                }

                const worksData = await listResponse.json();
                log(`API å“åº”: ${JSON.stringify(worksData).substring(0, 200)}...`);

                if (!worksData.works || worksData.works.length === 0) {
                    // å°è¯•å…¶ä»–APIç«¯ç‚¹
                    log('å°è¯•ä½¿ç”¨åª’ä½“åˆ—è¡¨API...');
                    const mediaResponse = await fetch('/api/list/media/1/1');
                    if (mediaResponse.ok) {
                        const mediaData = await mediaResponse.json();
                        if (mediaData.media && mediaData.media.length > 0) {
                            const testUuid = mediaData.media[0].uuid;
                            log(`ä»åª’ä½“åˆ—è¡¨è·å–æµ‹è¯•UUID: ${testUuid}`);
                            return await testRedirectWithUuid(testUuid);
                        }
                    }

                    // å°è¯•èµ„äº§åˆ—è¡¨API
                    log('å°è¯•ä½¿ç”¨èµ„äº§åˆ—è¡¨API...');
                    const assetResponse = await fetch('/api/list/asset/1/1');
                    if (assetResponse.ok) {
                        const assetData = await assetResponse.json();
                        if (assetData.assets && assetData.assets.length > 0) {
                            const testUuid = assetData.assets[0].uuid;
                            log(`ä»èµ„äº§åˆ—è¡¨è·å–æµ‹è¯•UUID: ${testUuid}`);
                            return await testRedirectWithUuid(testUuid);
                        }
                    }

                    // å¦‚æœéƒ½æ²¡æœ‰ï¼Œåˆ›å»ºä¸€ä¸ªæµ‹è¯•UUID
                    log('æ²¡æœ‰æ‰¾åˆ°çœŸå®æ–‡ä»¶ï¼Œä½¿ç”¨æµ‹è¯•UUID');
                    const testUuid = '00000000-0000-0000-0000-000000000001';
                    return await testRedirectWithUuid(testUuid, true);
                }

                const work = worksData.works[0];
                let testUuid = null;

                log(`ä½œå“ä¿¡æ¯: ${JSON.stringify(work).substring(0, 300)}...`);

                // æŸ¥æ‰¾åª’ä½“æ–‡ä»¶æˆ–èµ„æºæ–‡ä»¶
                if (work.media_sources && work.media_sources.length > 0) {
                    testUuid = work.media_sources[0].uuid;
                    log(`æ‰¾åˆ°åª’ä½“æ–‡ä»¶UUID: ${testUuid}`);
                } else if (work.assets && work.assets.length > 0) {
                    testUuid = work.assets[0].uuid;
                    log(`æ‰¾åˆ°èµ„äº§æ–‡ä»¶UUID: ${testUuid}`);
                }

                if (!testUuid) {
                    log('ä½œå“ä¸­æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ï¼Œä½¿ç”¨æµ‹è¯•UUID');
                    testUuid = '00000000-0000-0000-0000-000000000001';
                    return await testRedirectWithUuid(testUuid, true);
                }

                return await testRedirectWithUuid(testUuid);

            } catch (error) {
                updateStatus('redirect-status', 'âŒ é‡å®šå‘æµ‹è¯•å¤±è´¥', 'error');
                log('é‡å®šå‘æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
                log('é”™è¯¯è¯¦æƒ…: ' + error.stack, 'error');
                testResults.fileRedirect = false;
            }
        }

        // ä½¿ç”¨UUIDæµ‹è¯•é‡å®šå‘
        async function testRedirectWithUuid(testUuid, isTestUuid = false) {
            log(`æµ‹è¯•æ–‡ä»¶é‡å®šå‘: ${testUuid}${isTestUuid ? ' (æµ‹è¯•UUID)' : ''}`);

            try {
                // æµ‹è¯•é‡å®šå‘
                const redirectResponse = await fetch(`/api/get/file/${testUuid}`, {
                    method: 'HEAD', // åªè·å–å¤´éƒ¨ä¿¡æ¯
                    redirect: 'manual' // ä¸è‡ªåŠ¨è·Ÿéšé‡å®šå‘
                });

                log(`é‡å®šå‘å“åº”çŠ¶æ€: ${redirectResponse.status} ${redirectResponse.statusText}`);

                if (redirectResponse.status === 302) {
                    const location = redirectResponse.headers.get('location');
                    updateStatus('redirect-status', 'âœ… æ–‡ä»¶é‡å®šå‘æ­£å¸¸', 'success');
                    log(`é‡å®šå‘æˆåŠŸï¼Œç›®æ ‡: ${location}`, 'success');

                    // æµ‹è¯•ç›®æ ‡URLæ˜¯å¦å¯è®¿é—®ï¼ˆä»…å¯¹çœŸå®æ–‡ä»¶ï¼‰
                    if (location && !isTestUuid) {
                        try {
                            const targetResponse = await fetch(location, {
                                method: 'HEAD',
                                mode: 'no-cors' // é¿å…CORSé—®é¢˜
                            });
                            log('ç›®æ ‡æ–‡ä»¶è¿é€šæ€§æµ‹è¯•å®Œæˆ', 'info');
                        } catch (e) {
                            log('ç›®æ ‡æ–‡ä»¶è®¿é—®æµ‹è¯•å¤±è´¥ï¼ˆå¯èƒ½æ˜¯è·¨åŸŸé™åˆ¶ï¼Œè¿™æ˜¯æ­£å¸¸çš„ï¼‰', 'info');
                        }
                    }

                    testResults.fileRedirect = true;
                } else if (redirectResponse.status === 404) {
                    if (isTestUuid) {
                        updateStatus('redirect-status', 'âœ… é‡å®šå‘APIæ­£å¸¸ (404ä¸ºé¢„æœŸç»“æœ)', 'success');
                        log('æµ‹è¯•UUIDè¿”å›404ï¼Œé‡å®šå‘APIå·¥ä½œæ­£å¸¸', 'success');
                        testResults.fileRedirect = true;
                    } else {
                        updateStatus('redirect-status', 'âš ï¸ æ–‡ä»¶ä¸å­˜åœ¨', 'error');
                        log(`æ–‡ä»¶ä¸å­˜åœ¨: ${testUuid}`, 'error');
                        testResults.fileRedirect = false;
                    }
                } else {
                    updateStatus('redirect-status', 'âŒ æ–‡ä»¶é‡å®šå‘å¤±è´¥', 'error');
                    log(`é‡å®šå‘å¤±è´¥ï¼ŒçŠ¶æ€ç : ${redirectResponse.status}`, 'error');

                    // å°è¯•è·å–å“åº”å†…å®¹
                    try {
                        const responseText = await redirectResponse.text();
                        log(`å“åº”å†…å®¹: ${responseText.substring(0, 200)}`, 'error');
                    } catch (e) {
                        log('æ— æ³•è·å–å“åº”å†…å®¹', 'error');
                    }

                    testResults.fileRedirect = false;
                }
            } catch (error) {
                updateStatus('redirect-status', 'âŒ é‡å®šå‘è¯·æ±‚å¤±è´¥', 'error');
                log('é‡å®šå‘è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
                testResults.fileRedirect = false;
            }
        }

        // 5. æµ‹è¯•ç¼“å­˜åŠŸèƒ½
        async function testCaching() {
            log('æµ‹è¯•ç¼“å­˜åŠŸèƒ½...');

            if (!testResults.serviceWorker) {
                updateStatus('cache-status', 'âŒ Service Worker æœªæ¿€æ´»', 'error');
                log('Service Worker æœªæ¿€æ´»ï¼Œæ— æ³•æµ‹è¯•ç¼“å­˜', 'error');
                return;
            }

            try {
                // è¯·æ±‚ç¼“å­˜åˆ—è¡¨
                navigator.serviceWorker.controller.postMessage({
                    type: 'list_cache'
                });

                // è¯·æ±‚ç¼“å­˜ç»Ÿè®¡
                navigator.serviceWorker.controller.postMessage({
                    type: 'get_cache_stats'
                });

                log('å·²å‘é€ç¼“å­˜æµ‹è¯•è¯·æ±‚ï¼Œç­‰å¾…å“åº”...', 'info');
                updateStatus('cache-status', 'â³ ç­‰å¾…ç¼“å­˜å“åº”...', 'info');

                // è®¾ç½®è¶…æ—¶
                setTimeout(() => {
                    if (!testResults.cacheResponse) {
                        updateStatus('cache-status', 'âš ï¸ ç¼“å­˜å“åº”è¶…æ—¶', 'error');
                        log('ç¼“å­˜åŠŸèƒ½æµ‹è¯•è¶…æ—¶', 'error');
                    }
                }, 5000);

            } catch (error) {
                updateStatus('cache-status', 'âŒ ç¼“å­˜æµ‹è¯•å¤±è´¥', 'error');
                log('ç¼“å­˜æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æµ‹è¯•å¤–éƒ¨æ–‡ä»¶ç¼“å­˜
        async function testExternalFileCache() {
            log('æµ‹è¯•å¤–éƒ¨æ–‡ä»¶ç¼“å­˜åŠŸèƒ½...');

            if (!testResults.serviceWorker) {
                updateStatus('cache-status', 'âŒ Service Worker æœªæ¿€æ´»', 'error');
                log('Service Worker æœªæ¿€æ´»ï¼Œæ— æ³•æµ‹è¯•å¤–éƒ¨æ–‡ä»¶ç¼“å­˜', 'error');
                return;
            }

            // ç¡®ä¿æœ‰å¤–éƒ¨ä¸»æœºé…ç½®
            if (!testResults.externalHosts) {
                await checkExternalHosts();
            }

            if (!testResults.externalHosts || testResults.externalHosts.length === 0) {
                updateStatus('cache-status', 'âŒ æ²¡æœ‰å¤–éƒ¨å­˜å‚¨ä¸»æœºé…ç½®', 'error');
                log('æ²¡æœ‰æ£€æµ‹åˆ°å¤–éƒ¨å­˜å‚¨ä¸»æœºé…ç½®ï¼Œæ— æ³•æµ‹è¯•å¤–éƒ¨ç¼“å­˜', 'error');
                return;
            }

            try {
                log(`æ£€æµ‹åˆ° ${testResults.externalHosts.length} ä¸ªå¤–éƒ¨ä¸»æœº: ${testResults.externalHosts.join(', ')}`);

                // é¦–å…ˆæµ‹è¯•é€šè¿‡/api/get/fileæ¥å£è®¿é—®å¤–éƒ¨æ–‡ä»¶
                await testFileRedirectCache();

                // ç„¶åæµ‹è¯•ç›´æ¥è®¿é—®å¤–éƒ¨åŸŸåçš„æ–‡ä»¶ï¼ˆå¦‚æœå¯èƒ½ï¼‰
                await testDirectExternalAccess();

            } catch (error) {
                updateStatus('cache-status', 'âŒ å¤–éƒ¨æ–‡ä»¶ç¼“å­˜æµ‹è¯•å¤±è´¥', 'error');
                log('å¤–éƒ¨æ–‡ä»¶ç¼“å­˜æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æµ‹è¯•é€šè¿‡æ–‡ä»¶é‡å®šå‘çš„ç¼“å­˜
        async function testFileRedirectCache() {
            log('æµ‹è¯•æ–‡ä»¶é‡å®šå‘ç¼“å­˜...');

            try {
                // ä½¿ç”¨å›ºå®šçš„æµ‹è¯•æ–‡ä»¶UUIDï¼ˆå·²çŸ¥å­˜åœ¨çš„æ–‡ä»¶ï¼‰
                const testFileUuid = '17f113e6-dd6a-42d0-ae28-599b03a9109a';
                log(`ä½¿ç”¨æµ‹è¯•æ–‡ä»¶ UUID: ${testFileUuid}`);

                // æµ‹è¯•æ–‡ä»¶é‡å®šå‘
                const fileUrl = `/api/get/file/${testFileUuid}`;
                log(`æµ‹è¯•æ–‡ä»¶é‡å®šå‘: ${fileUrl}`);

                try {
                    const response = await fetch(fileUrl, {
                        method: 'GET', // æ”¹ä¸ºGET
                        redirect: 'follow' // å…è®¸è‡ªåŠ¨è·Ÿéšé‡å®šå‘
                    });

                    log(`æ–‡ä»¶é‡å®šå‘å“åº”çŠ¶æ€: ${response.status}`);
                    log(`æ–‡ä»¶é‡å®šå‘å“åº”URL: ${response.url}`);

                    if (response.ok) {
                        log(`âœ… é‡å®šå‘æˆåŠŸï¼Œæœ€ç»ˆURL: ${response.url}`, 'success');

                        // æ£€æŸ¥æ˜¯å¦æ˜¯å¤–éƒ¨URL
                        if (response.url.includes('assets.vocarchive.com')) {
                            log('âœ… æˆåŠŸè®¿é—®å¤–éƒ¨å­˜å‚¨æ–‡ä»¶', 'success');

                            // ç­‰å¾…ç¼“å­˜å¤„ç†
                            await new Promise(resolve => setTimeout(resolve, 1000));

                            // å†æ¬¡è®¿é—®ç›¸åŒURLåº”è¯¥ä»ç¼“å­˜è¿”å›
                            const secondResponse = await fetch(response.url, {
                                method: 'GET',
                                mode: 'no-cors'
                            });

                            log(`ç¬¬äºŒæ¬¡è®¿é—®å“åº”ç±»å‹: ${secondResponse.type}`, 'info');
                        }
                    } else {
                        log(`æ–‡ä»¶é‡å®šå‘å¤±è´¥: ${response.status} ${response.statusText}`, 'error');
                    }

                } catch (fetchError) {
                    log(`æ–‡ä»¶é‡å®šå‘è¯·æ±‚å¤±è´¥: ${fetchError.message}`, 'error');

                    // å°è¯•æ‰‹åŠ¨å¤„ç†é‡å®šå‘
                    try {
                        log('å°è¯•æ‰‹åŠ¨è·å–é‡å®šå‘URL...', 'info');
                        const manualResponse = await fetch(fileUrl, {
                            method: 'HEAD',
                            redirect: 'manual'
                        });

                        if (manualResponse.status === 302) {
                            const redirectUrl = manualResponse.headers.get('location');
                            log(`æ‰‹åŠ¨è·å–çš„é‡å®šå‘URL: ${redirectUrl}`, 'info');

                            if (redirectUrl) {
                                // ç›´æ¥è®¿é—®é‡å®šå‘URL
                                const directResponse = await fetch(redirectUrl, {
                                    method: 'GET',
                                    mode: 'no-cors'
                                });

                                log(`ç›´æ¥è®¿é—®é‡å®šå‘URLå“åº”ç±»å‹: ${directResponse.type}`, 'info');
                            }
                        }
                    } catch (manualError) {
                        log(`æ‰‹åŠ¨é‡å®šå‘ä¹Ÿå¤±è´¥: ${manualError.message}`, 'error');
                    }
                }

            } catch (error) {
                log(`æ–‡ä»¶é‡å®šå‘æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•ç›´æ¥è®¿é—®å¤–éƒ¨åŸŸå
        async function testDirectExternalAccess() {
            log('æµ‹è¯•ç›´æ¥å¤–éƒ¨åŸŸåè®¿é—®...');

            // ä½¿ç”¨å·²çŸ¥å­˜åœ¨çš„æ–‡ä»¶URLï¼ˆä»å‰é¢çš„é‡å®šå‘æµ‹è¯•è·å¾—ï¼‰
            const knownFileUrl = 'https://assets.vocarchive.com/WACCA_ULTRA_DREAM_MEGAMIX_1x1.webp';

            try {
                log(`æµ‹è¯•ç›´æ¥è®¿é—®: ${knownFileUrl}`);

                // ç¡®è®¤Service WorkerçŠ¶æ€
                if (!navigator.serviceWorker.controller) {
                    log('âš ï¸ Service Workeræœªæ§åˆ¶å½“å‰é¡µé¢ï¼Œå¯èƒ½æ— æ³•æ‹¦æˆªè¯·æ±‚', 'error');
                    return;
                }

                log('âœ… Service Workeræ­£åœ¨æ§åˆ¶å½“å‰é¡µé¢', 'info');

                // ç¬¬ä¸€æ¬¡è®¿é—® - åº”è¯¥ä»ç½‘ç»œè·å–å¹¶ç¼“å­˜
                log('å‘é€ç¬¬ä¸€æ¬¡è¯·æ±‚...', 'info');
                const response1 = await fetch(knownFileUrl, {
                    method: 'GET',
                    mode: 'no-cors' // é¿å…CORSé—®é¢˜
                });

                log(`ç¬¬ä¸€æ¬¡è®¿é—®å“åº”ç±»å‹: ${response1.type}`, 'info');
                log(`ç¬¬ä¸€æ¬¡è®¿é—®çŠ¶æ€: ${response1.status}`, 'info');

                // æ£€æŸ¥æ˜¯å¦æ¥è‡ªService Worker
                if (response1.headers) {
                    const swHeader = response1.headers.get('x-served-by-sw');
                    log(`æ˜¯å¦æ¥è‡ªService Worker: ${swHeader || 'å¦'}`, 'info');
                }

                // ç­‰å¾…ç¼“å­˜å¤„ç†
                await new Promise(resolve => setTimeout(resolve, 2000));

                // ç¬¬äºŒæ¬¡è®¿é—® - åº”è¯¥ä»ç¼“å­˜è¿”å›
                log('å‘é€ç¬¬äºŒæ¬¡è¯·æ±‚...', 'info');
                const response2 = await fetch(knownFileUrl, {
                    method: 'GET',
                    mode: 'no-cors'
                });

                log(`ç¬¬äºŒæ¬¡è®¿é—®å“åº”ç±»å‹: ${response2.type}`, 'info');
                log(`ç¬¬äºŒæ¬¡è®¿é—®çŠ¶æ€: ${response2.status}`, 'info');

                // åˆ†æç»“æœ
                if (response1.type === 'opaque' && response2.type === 'opaque') {
                    log('âœ… å¤–éƒ¨æ–‡ä»¶è®¿é—®æˆåŠŸï¼ŒService Workeræ­£ç¡®æ‹¦æˆª', 'success');
                } else if (response1.type === 'basic' && response2.type === 'basic') {
                    log('âŒ å¤–éƒ¨æ–‡ä»¶æœªè¢«Service Workeræ‹¦æˆªï¼Œå“åº”ç±»å‹ä¸ºbasic', 'error');
                    log('è¿™è¡¨æ˜Service Workeræ²¡æœ‰å¤„ç†å¤–éƒ¨åŸŸåè¯·æ±‚', 'error');
                } else {
                    log('âš ï¸ å¤–éƒ¨æ–‡ä»¶è®¿é—®çŠ¶æ€å¼‚å¸¸', 'error');
                }

                // å¼ºåˆ¶æµ‹è¯•Service Workeræ‹¦æˆª
                log('å°è¯•å¼ºåˆ¶è§¦å‘Service Workeræ‹¦æˆª...', 'info');

                // åˆ›å»ºä¸€ä¸ªæ–°çš„è¯·æ±‚æ¥æµ‹è¯•
                const testRequest = new Request(knownFileUrl, {
                    method: 'GET',
                    mode: 'no-cors'
                });

                const response3 = await fetch(testRequest);
                log(`å¼ºåˆ¶æµ‹è¯•å“åº”ç±»å‹: ${response3.type}`, 'info');

            } catch (error) {
                log(`ç›´æ¥å¤–éƒ¨åŸŸåè®¿é—®å¤±è´¥: ${error.message}`, 'error');
            }

            // ç­‰å¾…ç¼“å­˜å¤„ç†å®Œæˆ
            await new Promise(resolve => setTimeout(resolve, 2000));

            // æ£€æŸ¥ç¼“å­˜ä¸­çš„å¤–éƒ¨æ–‡ä»¶
            log('æ£€æŸ¥ç¼“å­˜ä¸­çš„å¤–éƒ¨æ–‡ä»¶...');
            navigator.serviceWorker.controller.postMessage({
                type: 'list_cache'
            });

            log('å¤–éƒ¨æ–‡ä»¶ç¼“å­˜æµ‹è¯•å®Œæˆï¼Œè¯·æ£€æŸ¥ç¼“å­˜å†…å®¹', 'success');
            updateStatus('cache-status', 'âœ… å¤–éƒ¨æ–‡ä»¶ç¼“å­˜æµ‹è¯•å®Œæˆ', 'success');
        }
        // åˆ›å»ºå¤–éƒ¨å­˜å‚¨æºé…ç½®
        async function createExternalStorageSource() {
            log('åˆ›å»ºæµ‹è¯•å¤–éƒ¨å­˜å‚¨æºé…ç½®...');

            try {
                // æ£€æŸ¥æ˜¯å¦æœ‰è®¤è¯
                const authToken = localStorage.getItem('authToken') || prompt('è¯·è¾“å…¥è®¤è¯ä»¤ç‰Œï¼ˆç”¨äºåˆ›å»ºå¤–éƒ¨å­˜å‚¨æºï¼‰:');
                if (!authToken) {
                    log('éœ€è¦è®¤è¯ä»¤ç‰Œæ‰èƒ½åˆ›å»ºå¤–éƒ¨å­˜å‚¨æº', 'error');
                    return;
                }

                // åˆ›å»ºä¸€ä¸ªæµ‹è¯•çš„å¤–éƒ¨å­˜å‚¨æº
                const testSource = {
                    uuid: crypto.randomUUID(),
                    type: 'raw_url',
                    name: 'æµ‹è¯•å¤–éƒ¨å­˜å‚¨æº',
                    endpoint: 'https://picsum.photos/{ID}'
                };

                const response = await fetch('/api/input/external_source', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(testSource)
                });

                if (response.ok) {
                    log(`å¤–éƒ¨å­˜å‚¨æºåˆ›å»ºæˆåŠŸ: ${testSource.name}`, 'success');
                    log(`ç«¯ç‚¹: ${testSource.endpoint}`, 'info');

                    // é‡æ–°æµ‹è¯•é…ç½®
                    await testConfigEndpoint();
                } else {
                    const errorText = await response.text();
                    log(`å¤–éƒ¨å­˜å‚¨æºåˆ›å»ºå¤±è´¥: ${response.status} - ${errorText}`, 'error');
                }

            } catch (error) {
                log('åˆ›å»ºå¤–éƒ¨å­˜å‚¨æºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // å¤„ç† Service Worker æ¶ˆæ¯
        function handleServiceWorkerMessage(event) {
            const { type, payload, stats } = event.data;

            switch (type) {
                case 'cache_list':
                    log(`æ”¶åˆ°ç¼“å­˜åˆ—è¡¨: ${payload ? payload.length : 0} é¡¹`, 'success');
                    if (payload && payload.length > 0) {
                        updateStatus('cache-status', `âœ… ç¼“å­˜åŠŸèƒ½æ­£å¸¸ (${payload.length} é¡¹)`, 'success');

                        // åˆ†æç¼“å­˜å†…å®¹
                        const hosts = [...new Set(payload.map(item => item.host))];
                        log(`ç¼“å­˜ä¸­çš„ä¸»æœº: ${hosts.join(', ')}`, 'info');

                        const types = [...new Set(payload.map(item => item.type))];
                        log(`ç¼“å­˜çš„æ–‡ä»¶ç±»å‹: ${types.join(', ')}`, 'info');
                    } else {
                        updateStatus('cache-status', 'âœ… ç¼“å­˜åŠŸèƒ½æ­£å¸¸ (ç©ºç¼“å­˜)', 'success');
                    }
                    testResults.cacheResponse = true;
                    break;

                case 'cache_stats':
                    log('æ”¶åˆ°ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯', 'success');
                    if (stats && stats.length > 0) {
                        const totalSize = stats.reduce((sum, stat) => sum + stat.totalSize, 0);
                        const totalFiles = stats.reduce((sum, stat) => sum + stat.fileCount, 0);
                        log(`ç¼“å­˜ç»Ÿè®¡: ${totalFiles} æ–‡ä»¶, ${(totalSize / 1024 / 1024).toFixed(2)} MB`, 'info');
                    }
                    break;

                case 'cache_cleared':
                    log('ç¼“å­˜å·²æ¸…ç†', 'success');
                    break;

                case 'cache_error':
                    log('ç¼“å­˜æ“ä½œé”™è¯¯: ' + event.data.error, 'error');
                    break;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨å¼€å§‹æµ‹è¯•
        window.addEventListener('load', async () => {
            log('å¼€å§‹ Service Worker åŠŸèƒ½æµ‹è¯•...', 'info');

            await checkServiceWorker();

            if (testResults.serviceWorker) {
                await testConfigEndpoint();
                await checkExternalHosts();
            }
        });
    </script>
</body>
</html>